<!doctype html><html lang="en"><head><meta charset="utf-8"/><link rel="icon" href="./favicon.ico"/><meta name="viewport" content="width=device-width,initial-scale=1"/><meta name="theme-color" content="#000000"/><meta name="description" content="Web site created using create-react-app"/><link rel="apple-touch-icon" href="./logo192.png"/><link rel="manifest" href="./manifest.json"/><link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous"><link href="https://fonts.googleapis.com/css2?family=Clicker+Script&family=Dancing+Script&family=Edu+VIC+WA+NT+Beginner:wght@500&family=Poppins:wght@200;300;400;500;600&display=swap" rel="stylesheet"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css"><title>React App</title><script defer="defer" src="./static/js/main.72523076.js"></script><link href="./static/css/main.073c9b0a.css" rel="stylesheet"></head><body><noscript>You need to enable JavaScript to run this app.</noscript><div id="root"></div><style>#page_main{display:none;width:100%;height:100%}#register_page{display:none}.right-bar{background-color:#fff;position:fixed;height:100%;width:25%;right:0;top:7%;box-shadow:0 0 5px #d3d3d3;z-index:-1}.user_online{width:100%;margin:2px 0;height:50px;border-radius:7px;display:flex}.user_online:hover{background-color:#d3d3d3;cursor:pointer}.user_online img{height:35px;width:35px;border-radius:50%;margin:2px 10px}.user_online p{font-family:'Dancing Script';font-size:25px;margin:3px}.active{width:10px;height:10px;border-radius:50%;background-color:green;position:absolute;margin-left:5px}.call-options{display:none}.right-bar-inner:hover .call-options{display:block}.left-bar{background-color:#fff;position:fixed;height:100%;width:25%;left:0;top:7%;box-shadow:0 0 5px #d3d3d3;z-index:-1}.conversation_mem{width:100%;margin:2px 0;height:50px;border-radius:7px;display:flex}.conversation_mem:hover{background-color:#d3d3d3;cursor:pointer}.conversation_mem img{height:35px;width:35px;border-radius:50%;margin:2px 10px}.conversation_mem p{font-family:'Dancing Script';font-size:15px;margin:3px}.send_message{position:fixed;bottom:0;width:50%;padding:0 5%;left:25%;display:flex;background-color:#fff}.send_message textarea{width:100%;border-radius:10px;box-shadow:1px 1px 1px #000;height:150px}.send_message .btn_function{width:30%}.send_message .btn{width:100%;margin:2% 5%;color:#fff;font-size:25px}.show_message{left:31%;position:absolute;width:48%;left:25%;top:9%;height:500px;bottom:250px;z-index:-1;display:block}.message_right{width:30%;border-radius:10px;background-color:#2532e6;color:#fff;margin-left:70%;position:relative;word-wrap:break-word;display:block}.message_right p{padding:5px}.message_left{width:30%;border-radius:10px;background-color:#d3d3d3;color:#000;margin-left:1%;position:relative;word-wrap:break-word;display:block}.message_left p{padding:5px}.videoContainer{margin:0 10%;display:flex}.VideoCallPage{padding-top:100px;display:none}.VideoCallPage h3{text-align:center}#notification_before_video_call{text-align:center}.call_group{display:none}.call_group h1{text-align:center}.popup_choose_mem_group{position:fixed;height:50%;width:50%;left:25%;top:25%;border-radius:10px;box-shadow:5px 5px 5px #000;background-color:#f6f5f5;display:none}#close-icon-call-group{position:absolute;right:0;padding:10px;font-size:15px;border-radius:100%}#close-icon-call-group:hover{background-color:#fff}.notification_received_call_group{position:fixed;left:30%;top:30%;border-radius:10px;box-shadow:2px 2px 2px #000;width:320px;height:300px;display:none}.notification_received_call_group button{margin:10px 110px;width:90px}.notification_received_call_group h5{text-align:center}</style><nav style="position:fixed;width:100%" class="navbar navbar-expand-lg navbar-light bg-light"><div class="container-fluid"><a class="navbar-brand" href="#">Message</a> <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav me-auto mb-2 mb-lg-0"><button type="button" class="btn btn-primary"><li style="display:flex" class="nav-item">Group <i style="padding:5px" class="fa-solid fa-plus"></i></li></button> <button style="margin-left:30px" type="button" class="btn btn-primary"><li style="display:flex;padding:0;margin-bottom:-13px" class="nav-item"><p id="account_user">Account</p><i style="padding:5px" class="fa-solid fa-file-invoice"></i></li></button> <button style="margin-left:30px" type="button" class="btn btn-primary"><li onclick="callgroup()" class="nav-item"><i class="fa-solid fa-users-rectangle"></i></li></button> <button style="margin-left:30px" type="button" class="btn btn-success"><li onclick="callgroupOfficial()" class="nav-item"><i class="fa-solid fa-users-rectangle"></i></li></button> <button style="margin-left:30px" type="button" class="btn btn-success"><li onclick="callgroupPeerServer()" class="nav-item"><i class="fa-solid fa-users-rectangle">PS</i></li></button> <button style="margin-left:30px" type="button" class="btn btn-success"><li onclick="LiveStream()" class="nav-item"><i class="fa-solid fa-users-rectangle">LiveStream</i></li></button></ul><form class="d-flex"><input class="form-control me-2" type="search" placeholder="Search" aria-label="Search"> <button class="btn btn-outline-success" type="submit">Search</button></form></div></div></nav><div id="page_main"><div class="right-bar"><h3 style="text-align:center;margin:25px">User Online</h3></div><div class="left-bar"><h3 style="text-align:center;margin:25px">Conversation</h3><div class="conversation_mem"><img src="https://image.vtc.vn/resize/th/upload/2021/03/03/messi-07382623.jpg"><p>coversation</p></div></div><div class="send_message"><textarea placeholder="Write something..."></textarea><div class="btn_function"><button onclick="sendMesage()" type="button" href="#gotoBottom" class="btn btn-primary"><i class="fa-solid fa-envelopes-bulk"></i></button> <button id="scrollTopButton" type="button" class="btn btn-success"><i class="fa-solid fa-upload"></i></button></div></div><div class="show_message"><h3 style="font-family:'Dancing Script';text-align:center">Please chose a conversation</h3></div></div><div class="VideoCallPage"><h3>Call Video</h3><div class="videoContainer"><video playsinline muted style="width:500px;height:500px" autoplay id="myvideo"></video><img class="img_before_video" style="width:500px;height:350px;margin-top:62px" src="https://thumbs.dreamstime.com/b/default-avatar-profile-vector-user-profile-default-avatar-profile-vector-user-profile-profile-179376714.jpg"><video playsinline muted style="width:500px;height:500px" autoplay id="uservideo"></video></div></div><div id="login_page"><h3 style="text-align:center">Login</h3><h3 style="margin-left:40%;margin-top:100px">Login</h3><input id="username_login" style="width:30%;margin:2% 30%" class="form-control form-control-sm" placeholder="email" aria-label=".form-control-sm example"> <input id="password_login" style="width:30%;margin:2% 30%" class="form-control form-control-sm" placeholder="password" aria-label=".form-control-sm example"> <button id="login" style="margin:.5% 40%;width:100px" type="button" class="btn btn-primary">Login</button> <button id="btn_gotoRegister" style="margin:.5% 40%;width:100px" type="button" class="btn btn-primary">Register</button></div><div id="register_page"><h3 style="text-align:center">Register</h3><h3 style="margin-left:40%;margin-top:100px">Register</h3><input id="username_regis" style="width:30%;margin:2% 30%" class="form-control form-control-sm" placeholder="username" aria-label=".form-control-sm example"> <input id="password_res" style="width:30%;margin:2% 30%" class="form-control form-control-sm" placeholder="password" aria-label=".form-control-sm example"> <input id="con_password_res" style="width:30%;margin:2% 30%" class="form-control form-control-sm" placeholder="confirm password" aria-label=".form-control-sm example"> <input id="email_res" style="width:30%;margin:2% 30%" class="form-control form-control-sm" placeholder="email" aria-label=".form-control-sm example"> <button id="btn_register" style="margin:.5% 40%;width:100px" type="button" class="btn btn-primary">Register</button> <button id="btn_goToLogin" style="margin:.5% 40%;width:100px" type="button" class="btn btn-primary">Login</button></div><div class="call_group"><div class="content_call_group"><h3 style="padding:70px">Video call group<input class="id_call_group_user" placeholder="type id socket"/> <button class="btn btn-primary" type="button" onclick="callTestGroup()">Call</button><div id="video-grid"></div></h3></div></div><div id="call_group_official" class="call_group"><div class="content_call_group"><h3 style="padding:70px">Video call group<div id="video-grid-official"></div></h3></div></div><div class="popup_choose_mem_group"><i id="close-icon-call-group" onclick="close_popup_choose_mem_call_group()" class="fa-solid fa-xmark"></i></div><div id="notification_received_call_group" class="notification_received_call_group"><h5>You have a call group</h5><button class="btn btn-primary" type="button" id="acceptedCallNotification" onclick="AcceptCallGroup()">Accepted</button><div class="info_group_name_recieved_official" style="display:none"></div></div><div id="call_group_livestream" class="call_group"><div class="content_call_group"><h3 style="padding:70px">Live stream<div id="video-grid-livestream"></div></h3></div></div><div id="notification_livestream" class="notification_received_call_group"><h5>Having a stream</h5><button class="btn btn-primary" type="button" id="acceptedCallNotification" onclick="SeeLiveStream()">SeeLiveStream</button></div><div class="popup_choose_mem_group"><i id="close-icon-call-group" onclick="close_popup_choose_mem_call_group()" class="fa-solid fa-xmark"></i></div><script src="https://cdnjs.cloudflare.com/ajax/libs/simple-peer/9.11.1/simplepeer.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.0.0-alpha.1/axios.min.js"></script><script src="https://cdn.socket.io/4.5.0/socket.io.min.js" integrity="sha384-7EyYLQZgWBi67fBtVxw60/OWl1kjsfrPFcaU0pp0nAh+i8FD068QogUvg85Ewy1k" crossorigin="anonymous"></script><script>const socket={},url="https://messenger-api-express.herokuapp.com/api/";let user,listConversation,currentConvId;socket.current=io("https://socket-server-nowrtc.herokuapp.com/");let userOnline=[];const renderConvesationByApi=async e=>{$(".left-bar").html(' <h3 style="text-align:center;margin:25px">Conversation</h3>');let t=(await axios.get(url+"conversations/"+e)).data;listConversation=t;const n=t.filter((e=>!0===e.status)),a=t.filter((e=>!1===e.status));for(let e=0;e<a.length;e++)n.push(a[e]);t=n;for(let n=0;n<t.length;n++){let a="",o=t[n].members.filter((t=>t!==e));for(let e=0;e<o.length;e++){const t=await axios.get(url+"users/getuser/"+o[e]);a=a+" "+String(t.data[0].username)}!0===t[n].status?$(".left-bar").append(`\n           <div onclick="renderMessageByConvId(this)" class="conversation_mem">\n               <img src="https://image.vtc.vn/resize/th/upload/2021/03/03/messi-07382623.jpg">\n               </img>\n               <p style="color:red;font-weight: 900;font-size:15px">${a}</p>\n               <p style="display:none"id="idConv">${t[n]._id}</p>\n               <p style="position:absolute;font-size:10px;right:30px">${t[n].updatedAt}</p>\n           </div>\n         `):$(".left-bar").append(`\n           <div onclick="renderMessageByConvId(this)" class="conversation_mem">\n               <img src="https://image.vtc.vn/resize/th/upload/2021/03/03/messi-07382623.jpg">\n               </img>\n               <p>${a}</p>\n               <p style="display:none"id="idConv">${t[n]._id}</p>\n               <p style="position:absolute;font-size:10px;right:30px">${t[n].updatedAt}</p>\n           </div>\n         `)}};let email=localStorage.getItem("email1"),password=localStorage.getItem("password1");const authen=async(e,t)=>{const n={email:e,password:t},a=await axios.post(url+"auth/login",n);null!=a.data.email&&($("#login_page").hide(),$("#page_main").show(),$("#account_user").text(a.data.username),user=a.data,socket.current.emit("addUser",user._id),renderConvesationByApi(user._id))};null!==email&&null!==password&&authen(email,password);const renderMessageByConvId=async e=>{const t=$(e).find("#idConv").text();currentConvId=t;await axios.post(url+"conversations/update",{id:currentConvId,status:!1});renderConvesationByApi(user._id);const n=(await axios.get(url+"messages/"+t)).data;$(".show_message").html("<div></div>");for(let e=n.length-1;e>=0;e--)if(n[e].sender==user._id){const t=await axios.get(url+"users/getuser/"+n[e].sender);$(".show_message").append(`\n             <div style="margin-top:60px"class="message_right">\n                 <img style="position:absolute;margin-top:-35px;height:30px;width:30px;border-radius:50%" src="https://vcdn-thethao.vnecdn.net/2020/09/06/top-messi-5407-1599376186.jpg">\n                 <p style="margin-left:30px;color:black;position:absolute;margin-top:-35px">${t.data[0].username}</p>\n                 <p>${n[e].text}</p>\n                 <p style="font-size:10px;position:absolute;margin-top:-20px">${n[e].createdAt}</p>\n             </div>\n           `)}else{const t=await axios.get(url+"users/getuser/"+n[e].sender);$(".show_message").append(`\n             <div style="margin-top:60px"class="message_left">\n                 <img style="position:absolute;margin-top:-35px;height:30px;width:30px;border-radius:50%" src="https://vcdn-thethao.vnecdn.net/2020/09/06/top-messi-5407-1599376186.jpg">\n                 <p style="margin-left:30px;position:absolute;margin-top:-35px">${t.data[0].username}</p>\n                 <p>${n[e].text}</p>\n                 <p style="font-size:10px;position:absolute;margin-top:-20px">${n[e].createdAt}</p>\n             </div>\n           `)}$(".show_message").append('\n             <div style="margin-top:60px"class="message_right">\n                 <p style="position:absolute;margin-top:-30px">hhhsvhds</p>\n                 <p>hsgsdysd</p>\n                 <p style="font-size:10px;position:absolute;margin-top:-20px">hgagsgdsg</p>\n             </div>\n        '),$(".show_message").append('\n             <div id="gotoBottom"style="margin-top:60px"class="message_right">\n                 <p style="position:absolute;margin-top:-30px">hhhsvhds</p>\n                 <p>hsgsdysd</p>\n                 <p style="font-size:10px;position:absolute;margin-top:-20px">hgagsgdsg</p>\n             </div>\n        ')},renderMessageByConvId_real=async e=>{const t=(await axios.get(url+"messages/"+e)).data;$(".show_message").html("<div></div>");for(let e=t.length-1;e>=0;e--)if(t[e].sender==user._id){const n=await axios.get(url+"users/getuser/"+t[e].sender);$(".show_message").append(`\n             <div style="margin-top:60px"class="message_right">\n                 <p style="position:absolute;margin-top:-30px">${n.data[0].username}</p>\n                 <p>${t[e].text}</p>\n                 <p style="font-size:10px;position:absolute;margin-top:-20px">${t[e].createdAt}</p>\n             </div>\n           `)}else{const n=await axios.get(url+"users/getuser/"+t[e].sender);$(".show_message").append(`\n             <div style="margin-top:60px"class="message_left">\n                 <p style="position:absolute;margin-top:-30px">${n.data[0].username}</p>\n                 <p>${t[e].text}</p>\n                 <p style="font-size:10px;position:absolute;margin-top:-20px">${t[e].createdAt}</p>\n             </div>\n           `)}$(".show_message").append('\n             <div style="margin-top:60px"class="message_right">\n                 <p style="position:absolute;margin-top:-30px">hhhsvhds</p>\n                 <p>hsgsdysd</p>\n                 <p style="font-size:10px;position:absolute;margin-top:-20px">hgagsgdsg</p>\n             </div>\n        '),$(".show_message").append('\n             <div id="gotoBottom"style="margin-top:60px"class="message_right">\n                 <p style="position:absolute;margin-top:-30px">hhhsvhds</p>\n                 <p>hsgsdysd</p>\n                 <p style="font-size:10px;position:absolute;margin-top:-20px">hgagsgdsg</p>\n             </div>\n        ')},sendMesage=async()=>{if(void 0!==currentConvId){const e=(await axios.get(url+"conversations/getconv/"+currentConvId)).data.members.filter((e=>e!==user._id)),t=$("textarea").val(),n={sender:user._id,text:t,conversationId:currentConvId};try{await axios.post(url+"conversations/update",{id:currentConvId,status:!0});const a=await axios.post(url+"messages",n);console.log(a.data),socket.current.emit("sendMessage",{senderId:user._id,receiverId:e,text:t,idConversation:currentConvId,idmes:a.data._id}),renderMessageByConvId_real(currentConvId)}catch(e){console.log(e)}}else alert("Please chose an conversation")};$("#btn_goToLogin").click((function(){$("#register_page").hide(),$("#login_page").show()})),$("#btn_gotoRegister").click((function(){$("#register_page").show(),$("#login_page").hide()})),$("#login").click((function(){const e=$("#username_login").val(),t=$("#password_login").val();localStorage.setItem("email",`${e}`),localStorage.setItem("password",`${t}`);const n={email:e,password:t};(async()=>{const e=await axios.post(url+"auth/login",n);null!=e.data.email?($("#login_page").hide(),$("#page_main").show(),$("#account_user").text(e.data.username),user=e.data,socket.current.emit("addUser",user._id),renderConvesationByApi(user._id)):alert("Thông tin đăng nhập không hợp lệ ")})()})),$("#btn_register").click((async()=>{const e=$("#password_res").val(),t=$("#con_password_res").val(),n=$("#email_res").val(),a=$("#username_regis").val();if(e===t){const t={username:a,email:n,password:e};try{const e=await axios.post(url+"auth/register",t);$("#register_page").hide(),$("#login_page").show(),e.data.username==a&&alert("Đăng ký thành công")}catch(e){alert(e)}}else alert("Failed confirm password")}));const renderUserOnlineByUserId=async e=>{$(".right-bar").html('<h3 style="text-align:center;margin:25px">User Online</h3>');for(let t=0;t<e.length;t++){const n=await axios.get(url+"users/getuser/"+e[t].userId);$(".right-bar").append(`\n               <div class="right-bar-inner">\n                 <div class="call-options">\n                   <button type="button" onclick="callvideo(this)"class="btn btn-success">\n                       <p style="display:none" id="contentCallVideo">${e[t].socketId}</p>\n                       <p style="display:none" id="nameCallVideo">${n.data[0].username}</p>\n                       <i class="fa-solid fa-video"></i>\n                   </button>\n                   <button type="button" class="btn btn-success">\n                       <i class="fa-solid fa-phone"></i>\n                   </button>\n                 </div>\n                 <div onclick="CreateConv(this)" class="user_online">\n                   <a id="id_user_online"style="display:none">${n.data[0]._id}<a/>\n                   <img src="https://media.bongda.com.vn/files/anh.nguyen/2022/07/07/messi-0937.png">\n                     <div class="active"></div>\n                   </img>\n                   <p>${n.data[0].username}</p>\n                 </div>\n               </div>\n           `)}},CreateConv=async e=>{let t=$(e).find("#id_user_online").text();if(listConversation.filter((e=>e.members.length<3)).filter((e=>e.members.includes(t))).length>0)alert("You had conversation with this person! Try again");else{const e=await axios.post(url+"conversations",{senderId:user._id,receiverId:t});socket.current.emit("CreateConversation",{_id:e.data._id,senderId:user._id,receiver:t}),renderConvesationByApi(user._id)}};let localStream,signalArrival,idCaller,UserToCallId,currentpeer;socket.current.on("getUsers",(e=>{void 0!==user._id&&(userOnline=e.filter((e=>e.userId!==user._id))),renderUserOnlineByUserId(userOnline)})),socket.current.on("getMessage",(async e=>{const t=await axios.get(url+"users/getuser/"+e.senderId);new Notification("Tin nhắn mới",{body:`${t.data[0].username} : ${e.text}`}),e.idConversation==currentConvId?(renderMessageByConvId_real(currentConvId),renderConvesationByApi(user._id)):renderConvesationByApi(user._id)})),socket.current.on("getConversation",(e=>{e.members.includes(user._id)&&renderConvesationByApi(user._id)})),socket.current.on("callUser",(e=>{signalArrival=e.signal,idCaller=e.from,$("#page_main").hide(),$(".VideoCallPage").show(),$(".VideoCallPage").append(`\n           <div class="notification_calling_for_receiver">\n             <h4 id="notification_before_video_call">${e.name} is calling</h4>\n             <button style="margin:2% 45%" onclick="Answer()" class="btn btn-success">\n               Answer\n             </button>\n           </div>\n         `)}));const Answer=async()=>{const e=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0});localStream=e,document.getElementById("myvideo").srcObject=e;const t=new SimplePeer({initiator:!1,trickle:!1,stream:localStream});t.signal(signalArrival),t.on("signal",(e=>{console.log(e),socket.current.emit("answerCall",{signal:e,to:idCaller})})),t.on("stream",(e=>{$(".img_before_video").hide(),document.getElementById("uservideo").srcObject=e})),$(".notification_calling_for_receiver").hide(),$(".VideoCallPage").append('\n           <button style="margin:2% 45%" onclick="endCall()" class="btn btn-danger">\n             END CALL\n           </button>\n           <button id="mute_receiver" type="button" class="btn btn-info">\n             <i class="fa-solid fa-microscope"></i>\n           </button>\n           <button type="button" class="btn btn-primary">\n             <i class="fa-solid fa-camera-retro"></i>\n           </button>\n       '),socket.current.on("unmuteCaller",(e=>{$("#uservideo").prop("muted",!1)})),socket.current.on("endCall",(e=>{console.log(e),window.location.reload()})),socket.current.on("turn_off_cam_caller",(e=>{$(".videoContainer").append('\n         <img style="position:absolute;width:600px;z-index:10;left:650px; height:390px;margin-top:60px" src="https://thumbs.dreamstime.com/b/default-avatar-profile-vector-user-profile-default-avatar-profile-vector-user-profile-profile-179376714.jpg"></img>\n     \n         ')}))},endCall=()=>{socket.current.emit("endCall",{idpartner:idCaller}),window.location.reload()},endCallBeforeVideoCall=()=>{window.location.reload()},endCall_Caller=()=>{let e=$("#usertocall_caller").text();socket.current.emit("endCall",{idpartner:e}),window.location.reload()},un_mute_caller=()=>{socket.current.emit("unmuteCaller",{idpartner:UserToCallId,userId:user._id})},turnOffCameraCaller=()=>{console.log(localStream.getVideoTracks()[0]),localStream.getVideoTracks().forEach((e=>e.enabled=!1)),socket.current.emit("turn_off_cam_caller",{idpartner:UserToCallId,userId:user._id})},callvideo=async e=>{UserToCallId=$(e).find("#contentCallVideo").text(),$("#page_main").hide(),$(".VideoCallPage").show(),$(".VideoCallPage").append('\n           <h4 id="notification_before_video_call">Waiting for moment</h4>\n           <button id="endcall_before_videocall" style="margin:2% 45%" onclick="endCallBeforeVideoCall()" class="btn btn-danger">\n             END CALL\n           </button>\n         ');const t=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0});localStream=t,document.getElementById("myvideo").srcObject=t;const n=new SimplePeer({initiator:!0,trickle:!1,stream:localStream});n.on("signal",(e=>{socket.current.emit("callUser",{userToCall:UserToCallId,signalData:e,from:user._id,name:user.username})})),socket.current.on("callAccepted",(e=>{n.signal(e),$("#notification_before_video_call").hide(),$("#endcall_before_videocall").hide(),$(".VideoCallPage").append(`\n           <button id="endcall_before_videocall" style="margin:2% 45%" onclick="endCall_Caller()" class="btn btn-danger">\n             <div style="display:none" id="usertocall_caller">${UserToCallId}</div>\n             END CALL\n           </button>\n           <button id="un_mute_caller_id" onclick="un_mute_caller()" type="button" class="btn btn-info">\n             <i class="fa-solid fa-microscope"></i>\n           </button>\n           <button type="button" id="turn_off_cam_caller" onclick="turnOffCameraCaller()" class="btn btn-primary">\n             <i class="fa-solid fa-camera-retro"></i>\n           </button>\n         `)})),n.on("stream",(e=>{$(".img_before_video").hide(),document.getElementById("uservideo").srcObject=e})),currentpeer=n,socket.current.on("endCall",(e=>{console.log(e),window.location.reload()})),socket.current.on("unmuteCaller",(async e=>{$("#un_mute_caller_id").hide(),$(".VideoCallPage").append('\n             <button type="button" class="btn btn-info">\n               <i class="fa-solid fa-microphone-slash"></i>\n             </button>\n           ')})),socket.current.on("turn_off_cam_caller",(e=>{$("#turn_off_cam_caller").hide(),$(".VideoCallPage").append('\n             <button type="button" class="btn btn-info">\n               <i class="fa-solid fa-camera-slash"></i>\n             </button>\n           ')}))};let videoGrid=document.getElementById("video-grid"),videoGridOficial=document.getElementById("video-grid-official");socket.current.on("signal_call_group",(e=>{$("#page_main").hide(),$(".call_group").show(),$(".call_group").append('\n           <div class="notification_calling_for_receiver">\n             <h4 id="notification_before_video_call">You have a call group</h4>\n             <button style="margin:2% 45%" onclick="AnswerCallGroup()" class="btn btn-success">\n               Answer\n             </button>\n           </div>\n         ')}));const callgroup=()=>{$("#page_main").hide(),$(".call_group").show()},callTestGroup=async()=>{const e=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0});localStream=e;const t=document.createElement("video");addVideoStream(t,localStream);const n=new SimplePeer({initiator:!0,trickle:!1,stream:localStream});n.on("signal",(e=>{socket.current.emit("callUserTestGroup",{userToCall:userOnline[0].socketId,signalData:e,from:user._id,name:user.username})})),n.on("stream",(e=>{console.log("connected")})),socket.current.on("TestGroupCallerTakeStreamServer",(e=>{n.signal(e)})),socket.current.on("transformOfferAnswerToCaller",(async e=>{const t=new SimplePeer({initiator:!1,trickle:!1,stream:localStream});t.signal(e),t.on("signal",(e=>{})),t.on("stream",(e=>{const t=document.createElement("video");addVideoStream(t,e)}))}))},AnswerCallGroup=async()=>{const e=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0});localStream=e;const t=document.createElement("video");addVideoStream(t,localStream);const n=new SimplePeer({initiator:!0,trickle:!1,stream:localStream});n.on("signal",(e=>{socket.current.emit("callUserTestGroupAnswer",{userCalled:userOnline[0].socketId,signalData:e})})),n.on("stream",(e=>{console.log("Nhận đc stream từ server"),console.log(e);const t=document.createElement("video");addVideoStream(t,e)})),socket.current.on("TestGroupAnswerTakeStreamServer",(e=>{n.signal(e)}))},addVideoStream=(e,t)=>{e.srcObject=t,e.addEventListener("loadedmetadata",(()=>{e.play()})),videoGrid.append(e)};let numMember,listUserToCallGroup=[];socket.current.on("ReceivedCallGroup",(async e=>{let t;for(let n=0;n<userOnline.length;n++)userOnline[n].socketId==e.userCall&&(t=userOnline[n].userId);$("#notification_received_call_group").show();const n=await axios.get(url+"users/getuser/"+t);$("#notification_received_call_group").append(`\n          <h5>${n.data[0].username} is calling you in a group</h5>\n       `),$(".info_group_name_recieved_official").text(e.roomName)}));const callgroupOfficial=async()=>{$(".popup_choose_mem_group").show(),$(".popup_choose_mem_group").html('\n          <i id="close-icon-call-group" onclick="close_popup_choose_mem_call_group()" class="fa-solid fa-xmark"></i>\n          <h5 style="text-align:center;margin:25px">List User</h3>\n           <button style="margin:0px 150px" type="button" class="btn btn-primary">\n             <li onclick ="SendListMemberCallGroup()" class="nav-item">\n               Call\n             </li>\n           </button>\n         ');for(let e=0;e<userOnline.length;e++){const t=await axios.get(url+"users/getuser/"+userOnline[e].userId);$(".popup_choose_mem_group").append(`\n               <div class="right-bar-inner">\n                 <div  class="user_online">\n                   <a id="id_user_online"style="display:none">${t.data[0]._id}<a/>\n                   <img style="position:absolute ;display:inline-block" src="https://media.bongda.com.vn/files/anh.nguyen/2022/07/07/messi-0937.png">\n                     <div class="active"></div>\n                   </img>\n                   <p style="position:absolute ;display:inline-block; left:70px">${t.data[0].username}</p>\n                   <input style="margin:15px; font-size:30px;position:absolute; display:inline-block; right:15px" type="checkbox" onchange="chooseUserToCall(this)"value=${userOnline[e].socketId}/>\n                 </div>\n               </div>\n           `)}},close_popup_choose_mem_call_group=()=>{$(".popup_choose_mem_group").hide()},chooseUserToCall=e=>{let t=$(e).val().split("/")[0];listUserToCallGroup.includes(t)?listUserToCallGroup=listUserToCallGroup.filter((e=>e!=t)):listUserToCallGroup.push(t)},SendListMemberCallGroup=async()=>{$("#page_main").hide(),$("#call_group_official").show();const e=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0});localStream=e;const t=document.createElement("video");addVideoStreamOfficial(t,localStream);const n=new SimplePeer({initiator:!0,trickle:!1,stream:localStream});n.on("signal",(e=>{socket.current.emit("sendSignalUserEmit",{signalData:e})})),socket.current.on("takeSignalBackFromServerTrackInit",(e=>{n.signal(e),console.log("Hoàn thành đẩy stream vào hệ thống"),console.log(e),console.log(listUserToCallGroup),socket.current.emit("SendListMemberCallGroupOfficial",listUserToCallGroup)}))},AcceptCallGroup=async()=>{$(".notification_received_call_group").hide(),$("#page_main").hide(),$("#call_group_official").show();const e=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0});localStream=e;const t=document.createElement("video");addVideoStreamOfficial(t,localStream);const n=new SimplePeer({initiator:!0,trickle:!1,stream:localStream});n.on("signal",(e=>{socket.current.emit("CallAcceptedGroupOfficial",{signalData:e,roomName:$(".info_group_name_recieved_official").text()})})),socket.current.on("SignalAnswerNewUserWhenChildUserPushFirstStream",(e=>{n.signal(e.signalAnswer),console.log("Hoàn thành đẩy stream vào hệ thống"),console.log(e),socket.current.emit("notification_new_user_join",{roomName:e.roomName})}))};let nameStreamArrival;socket.current.on("new_user_connected_official",(async e=>{console.log(`${e.socketId} joined room!`);const t=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0}),n=new SimplePeer({initiator:!0,trickle:!1,stream:t});n.on("signal",(t=>{socket.current.emit("takeStreamUserByRoomNameAndSocketId",{signalData:t,roomName:e.roomName,nameStream:e.socketId})})),socket.current.on("signalAnswerForUserTakeLiveStream",(e=>{console.log(nameStreamArrival),n.signal(e.signalAnswer),console.log(e),console.log(`Đã kết nối với stream ${e.nameStream}`)})),n.on("stream",(e=>{const t=document.createElement("video");t.setAttribute("id",`${e.id}`),addVideoStreamOfficial(t,e)}))})),socket.current.on("test",(e=>{console.log(e)}));const addVideoStreamOfficial=(e,t)=>{e.setAttribute("style"," width: 150px; height: 150px;"),e.srcObject=t,e.addEventListener("loadedmetadata",(()=>{e.play()})),videoGridOficial.append(e)};let videoGridStream=document.getElementById("video-grid-livestream");const LiveStream=async()=>{$("#page_main").hide(),$("#call_group_livestream").show();const e=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0});localStream=e,console.log(localStream);const t=document.createElement("video");addVideoStreamLive(t,localStream);const n=new SimplePeer({initiator:!0,trickle:!1,stream:localStream});n.on("signal",(e=>{socket.current.emit("livestream",{signalData:e})})),socket.current.on("answerSignalBeforeTakeLiveStream",(e=>{console.log(e),n.signal(e)}))};socket.current.on("haveLiveStream",(async e=>{let t;for(let n=0;n<userOnline.length;n++)userOnline[n].socketId==e.useLiveStream&&(t=userOnline[n].userId);const n=await axios.get(url+"users/getuser/"+t);$("#notification_livestream").show(),$("#notification_livestream").append(`\n         <h5>${n.data[0].username} is live stream</h5>\n       `)}));const SeeLiveStream=async()=>{$("#page_main").hide(),$("#call_group_livestream").show(),$("#notification_livestream").hide();const e=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0}),t=new SimplePeer({initiator:!0,trickle:!1,stream:e});t.on("signal",(e=>{socket.current.emit("SeeLiveStream",{signalData:e})})),socket.current.on("signalAnswerForUserTakeLiveStream",(e=>{console.log(e),t.signal(e)})),t.on("stream",(e=>{console.log(e),addVideoStreamLive(document.createElement("video"),e)}))},addVideoStreamLive=(e,t)=>{e.setAttribute("style"," width: 150px; height: 150px;"),e.srcObject=t,e.addEventListener("loadedmetadata",(()=>{e.play()})),videoGridStream.append(e)},callgroupPeerServer=async()=>{$(".popup_choose_mem_group").show(),$(".popup_choose_mem_group").html('\n          <i id="close-icon-call-group" onclick="close_popup_choose_mem_call_group()" class="fa-solid fa-xmark"></i>\n          <h5 style="text-align:center;margin:25px">List User</h3>\n           \n             <button style="margin:0px 150px" type="button" class="btn btn-primary">\n               <li onclick ="SendListMemberCallGroupPS()" class="nav-item">\n                 Call\n               </li>\n             </button>\n           \n         ');for(let e=0;e<userOnline.length;e++){const t=await axios.get(url+"users/getuser/"+userOnline[e].userId);$(".popup_choose_mem_group").append(`\n               <div class="right-bar-inner">\n                 <div  class="user_online">\n                   <a id="id_user_online"style="display:none">${t.data[0]._id}<a/>\n                   <img style="position:absolute ;display:inline-block" src="https://media.bongda.com.vn/files/anh.nguyen/2022/07/07/messi-0937.png">\n                     <div class="active"></div>\n                   </img>\n                   <p style="position:absolute ;display:inline-block; left:70px">${t.data[0].username}</p>\n                   <input style="margin:15px; font-size:30px;position:absolute; display:inline-block; right:15px" type="checkbox" onchange="chooseUserToCall(this)"value=${userOnline[e].socketId}/>\n                 </div>\n               </div>\n           `)}},SendListMemberCallGroupPS=()=>{socket.current.emit("SendListMemberCallGroupPS",{listUserToCallGroup:listUserToCallGroup,linkGroup:`https://group-chat-video-peerserver.herokuapp.com/${socket.current.id}timviec365PS`}),window.location.href=`https://group-chat-video-peerserver.herokuapp.com/${socket.current.id}timviec365PS/${$("#account_user").text()}`};socket.current.on("ReceivedCallGroupPS",(async e=>{let t;for(let n=0;n<userOnline.length;n++)userOnline[n].socketId==e.userCall&&(t=userOnline[n].userId);$(".notification_received_call_group").show();const n=await axios.get(url+"users/getuser/"+t);$(".notification_received_call_group").html(`\n         <h4 style="text-align:center">You have a call group</h4>\n\n         <a href="${e.linkroom}/${$("#account_user").text()}">\n           <button class="btn btn-primary"> Accept</button>\n         </a>\n         <h5>${n.data[0].username} is calling you in a group</h5>\n       `)}))</script></body></html>